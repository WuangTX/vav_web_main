{% extends 'base.html' %}
{% load static %}

{% block title %}Tr·ª£ l√Ω ·∫£o VAV Furniture{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        max-width: 800px;
        margin-top: 4.5rem !important;
        margin: 0 auto;
        height: 600px;
        border: 1px solid #ddd;
        border-radius: 10px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
    }
    
    .chat-header h3 {
        margin: 0;
        font-size: 1.4rem;
    }
    
    .chat-header p {
        margin: 5px 0 0 0;
        opacity: 0.9;
        font-size: 0.9rem;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 20px;
        background: #f8f9fa;
        scroll-behavior: smooth;
        /* NgƒÉn ch·∫∑n scroll propagation */
        overscroll-behavior: contain;
        /* ƒê·∫£m b·∫£o container c√≥ k√≠ch th∆∞·ªõc c·ªë ƒë·ªãnh */
        height: 100%;
        position: relative;
    }
    
    .message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
    }
    
    .message.user {
        justify-content: flex-end;
    }
    
    .message-content {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
    }
    
    .message.bot .message-content {
        background: white;
        border: 1px solid #e1e8ed;
        margin-left: 10px;
    }
    
    .message.user .message-content {
        background: #667eea;
        color: white;
        margin-right: 10px;
    }
    
    .avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 14px;
    }
    
    .avatar.bot {
        background: #28a745;
    }
    
    .avatar.user {
        background: #667eea;
    }
    
    .recommendations {
        margin-top: 10px;
        margin-left: 45px; /* CƒÉn s√°t ph√≠a chat bot (avatar 35px + margin 10px) */
        margin-right: auto;
        max-width: 65%;
        align-self: flex-start;
    }
    
    .recommendation-item {
        background: white;
        border: 1px solid #e1e8ed;
        border-radius: 12px;
        padding: 15px;
        margin: 10px 0;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .recommendation-item:hover {
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        transform: translateY(-3px);
        border-color: #667eea;
    }
    
    .recommendation-item:hover .recommendation-image {
        transform: scale(1.02);
    }
    
    .recommendation-image {
        width: 100%;
        height: 200px;
        border-radius: 8px;
        margin-bottom: 15px;
        object-fit: cover;
        border: 1px solid #e1e8ed;
        transition: transform 0.3s ease;
    }
    
    .recommendation-image-placeholder {
        width: 100%;
        height: 200px;
        border-radius: 8px;
        margin-bottom: 15px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        color: #666;
        border: 1px solid #e1e8ed;
    }
    
    .recommendation-content {
        flex: 1;
        min-width: 0;
    }
    
    .recommendation-title {
        font-weight: bold;
        color: #333;
        margin-bottom: 8px;
        font-size: 16px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .recommendation-meta {
        font-size: 13px;
        color: #667eea;
        margin-bottom: 8px;
        font-weight: 500;
    }
    
    .recommendation-description {
        font-size: 12px;
        color: #666;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .chat-input-container {
        padding: 20px;
        background: white;
        border-top: 1px solid #e1e8ed;
    }
    
    .chat-input-group {
        display: flex;
        gap: 10px;
    }
    
    .chat-input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 25px;
        outline: none;
        font-size: 14px;
    }
    
    .chat-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
    }
    
    .send-btn {
        padding: 12px 20px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s ease;
    }
    
    .send-btn:hover:not(:disabled) {
        background: #5a6fd8;
    }
    
    .send-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    .typing-indicator {
        display: none;
        align-items: center;
        padding: 10px;
        color: #666;
        font-style: italic;
    }
    
    .typing-dots {
        display: inline-block;
        margin-left: 5px;
    }
    
    .typing-dots span {
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #667eea;
        margin: 0 1px;
        animation: typing 1.5s infinite;
    }
    
    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-10px);
        }
    }
    
    .quick-actions {
        margin-bottom: 15px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .quick-action-btn {
        padding: 8px 16px;
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }
    
    .quick-action-btn:hover {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
    
    .feedback-buttons {
        margin-top: 8px;
        display: flex;
        gap: 5px;
    }
    
    .feedback-btn {
        padding: 5px 8px;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.3s ease;
    }
    
    .feedback-btn.thumbs-up {
        background: #28a745;
        color: white;
    }
    
    .feedback-btn.thumbs-down {
        background: #dc3545;
        color: white;
    }
    
    .feedback-btn:hover {
        opacity: 0.8;
    }

    /* Typewriter effect */
    .typewriter-text {
        border-right: 2px solid #667eea;
        animation: blink-caret 1s step-end infinite;
    }

    @keyframes blink-caret {
        from, to { border-color: transparent; }
        50% { border-color: #667eea; }
    }

    .smooth-scroll {
        scroll-behavior: smooth;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="chat-container">
                <div class="chat-header">
                    <h3>ü§ñ Tr·ª£ l√Ω ·∫£o VAV Furniture</h3>
                    <p>T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√¨m ki·∫øm s·∫£n ph·∫©m, d·ª± √°n v√† t∆∞ v·∫•n n·ªôi th·∫•t</p>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="quick-actions">
                        <div class="quick-action-btn" onclick="sendQuickMessage('T√¥i mu·ªën t√¨m hi·ªÉu v·ªÅ s·∫£n ph·∫©m sofa')">
                            üõãÔ∏è T√¨m sofa
                        </div>
                        <div class="quick-action-btn" onclick="sendQuickMessage('Cho t√¥i xem c√°c d·ª± √°n bi·ªát th·ª±')">
                            üè† D·ª± √°n bi·ªát th·ª±
                        </div>
                        <div class="quick-action-btn" onclick="sendQuickMessage('Quy tr√¨nh thi·∫øt k·∫ø c·ªßa VAV nh∆∞ th·∫ø n√†o?')">
                            üìã Quy tr√¨nh thi·∫øt k·∫ø
                        </div>
                        <div class="quick-action-btn" onclick="sendQuickMessage('Th√¥ng tin li√™n h·ªá')">
                            üìû Li√™n h·ªá
                        </div>
                        <div class="quick-action-btn" onclick="sendQuickMessage('Tin t·ª©c m·ªõi nh·∫•t v·ªÅ n·ªôi th·∫•t')">
                            üì∞ Tin t·ª©c
                        </div>
                    </div>
                    
                    <div class="message bot">
                        <div class="avatar bot">VAV</div>
                        <div class="message-content">
                            Xin ch√†o! T√¥i l√† tr·ª£ l√Ω ·∫£o c·ªßa VAV Furniture. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:
                            <br>‚Ä¢ T√¨m ki·∫øm s·∫£n ph·∫©m n·ªôi th·∫•t
                            <br>‚Ä¢ Xem c√°c d·ª± √°n ƒë√£ th·ª±c hi·ªán
                            <br>‚Ä¢ T√¨m hi·ªÉu v·ªÅ quy tr√¨nh thi·∫øt k·∫ø
                            <br>‚Ä¢ ƒê·ªçc tin t·ª©c v·ªÅ n·ªôi th·∫•t
                            <br>‚Ä¢ T∆∞ v·∫•n thi·∫øt k·∫ø v√† l·ª±a ch·ªçn s·∫£n ph·∫©m
                            <br>‚Ä¢ Cung c·∫•p th√¥ng tin li√™n h·ªá
                            <br><br>üìû Hotline: <strong>0935908007</strong> | üìß Email: <strong>vavfurniture.danang@gmail.com</strong>
                            <br><br>B·∫°n c√≥ c√¢u h·ªèi g√¨ cho t√¥i kh√¥ng?
                        </div>
                    </div>
                </div>
                
                <div class="typing-indicator" id="typingIndicator">
                    <div class="avatar bot">VAV</div>
                    <span>ƒêang tr·∫£ l·ªùi</span>
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <div class="chat-input-group">
                        <input type="text" 
                               id="chatInput" 
                               class="chat-input" 
                               placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..."
                               onkeypress="handleKeyPress(event)">
                        <button id="sendBtn" class="send-btn" onclick="event.preventDefault(); event.stopPropagation(); sendMessage();">
                            G·ª≠i
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let sessionId = null;

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        event.preventDefault(); // NgƒÉn ch·∫∑n default behavior c·ªßa Enter
        event.stopPropagation(); // NgƒÉn ch·∫∑n event bubbling
        sendMessage();
    }
}

function sendQuickMessage(message) {
    document.getElementById('chatInput').value = message;
    sendMessage();
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Hi·ªÉn th·ªã tin nh·∫Øn ng∆∞·ªùi d√πng
    addMessage('user', message);
    
    // X√≥a input v√† disable
    input.value = '';
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    
    // Hi·ªÉn th·ªã typing indicator
    showTypingIndicator();
    
    // G·ª≠i request
    fetch('{% url "chatbot:chat_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            session_id: sessionId
        })
    })
    .then(response => response.json())
    .then(data => {
        hideTypingIndicator();
        
        if (data.response) {
            sessionId = data.session_id;
            
            // Hi·ªÉn th·ªã ph·∫£n h·ªìi
            addMessage('bot', data.response, data.message_id);
            
            // Determine priority order based on topic
            const recommendations = [];
            
            if (data.products && data.products.length > 0) {
                recommendations.push({ type: 'products', items: data.products, priority: getTopicPriority(message, 'products') });
            }
            
            if (data.projects && data.projects.length > 0) {
                recommendations.push({ type: 'projects', items: data.projects, priority: getTopicPriority(message, 'projects') });
            }
            
            if (data.news && data.news.length > 0) {
                recommendations.push({ type: 'news', items: data.news, priority: getTopicPriority(message, 'news') });
            }
            
            // Sort by priority (higher first)
            recommendations.sort((a, b) => b.priority - a.priority);
            
            // Add recommendations in priority order
            recommendations.forEach(rec => {
                addRecommendations(rec.type, rec.items);
            });
        } else {
            addMessage('bot', 'Xin l·ªói, t√¥i kh√¥ng th·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi n√†y. Vui l√≤ng th·ª≠ l·∫°i.');
        }
        
        sendBtn.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        hideTypingIndicator();
        addMessage('bot', 'Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.');
        sendBtn.disabled = false;
    });
}

function getTopicPriority(message, type) {
    const messageLower = message.toLowerCase();
    
    // Keywords for each topic
    const topicKeywords = {
        'news': ['tin', 't·ª©c', 'news', 'b√†i', 'vi·∫øt', 'th√¥ng', 'tin', 'm·ªõi', 'nh·∫•t'],
        'projects': ['d·ª±', '√°n', 'project', 'thi·∫øt', 'k·∫ø', 'design', 'quy', 'tr√¨nh', 'bi·ªát', 'th·ª±', 'villa', 'cƒÉn', 'h·ªô', 'vƒÉn', 'ph√≤ng', 'kh√¥ng', 'gian', 'thi', 'c√¥ng'],
        'products': ['s·∫£n', 'ph·∫©m', 'product', 'sofa', 'b√†n', 'gh·∫ø', 'gi∆∞·ªùng', 't·ªß', 'furniture', 'n·ªôi', 'th·∫•t', 'ƒë·ªì', 'mua', 'b√°n', 'gi√°']
    };
    
    // Count matching keywords
    let score = 0;
    const keywords = topicKeywords[type] || [];
    
    keywords.forEach(keyword => {
        if (messageLower.includes(keyword)) {
            score += 10;
            
            // Bonus for exact word match
            const regex = new RegExp(`\\b${keyword}\\b`, 'i');
            if (regex.test(messageLower)) {
                score += 5;
            }
        }
    });
    
    // Special high priority keywords
    const highPriorityKeywords = {
        'news': ['tin t·ª©c', 'b√†i vi·∫øt', 'tin m·ªõi'],
        'projects': ['quy tr√¨nh thi·∫øt k·∫ø', 'd·ª± √°n', 'thi·∫øt k·∫ø', 'thi c√¥ng'],
        'products': ['s·∫£n ph·∫©m', 'mua s·∫Øm', 'furniture']
    };
    
    const highKeywords = highPriorityKeywords[type] || [];
    highKeywords.forEach(keyword => {
        if (messageLower.includes(keyword)) {
            score += 20;
        }
    });
    
    return score;
}

function addMessage(type, content, messageId = null) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    
    const avatar = type === 'bot' ? 'VAV' : 'B·∫°n';
    
    if (type === 'bot') {
        // T·∫°o message v·ªõi n·ªôi dung tr·ªëng tr∆∞·ªõc
        messageDiv.innerHTML = `
            <div class="avatar ${type}">${avatar}</div>
            <div class="message-content">
                <span class="typewriter-content"></span>
                ${messageId ? `
                    <div class="feedback-buttons" style="display: none;">
                        <button class="feedback-btn thumbs-up" onclick="sendFeedback(${messageId}, 5)">üëç</button>
                        <button class="feedback-btn thumbs-down" onclick="sendFeedback(${messageId}, 1)">üëé</button>
                    </div>
                ` : ''}
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        
        // Cu·ªôn m∆∞·ª£t trong container chat, KH√îNG ·∫£nh h∆∞·ªüng ƒë·∫øn trang
        requestAnimationFrame(() => {
            const targetScrollTop = messagesContainer.scrollHeight - messagesContainer.clientHeight;
            messagesContainer.scrollTop = Math.max(0, targetScrollTop);
        });
        
        // B·∫Øt ƒë·∫ßu hi·ªáu ·ª©ng typewriter
        typeWriterEffect(messageDiv.querySelector('.typewriter-content'), content, messageId);
    } else {
        // User message hi·ªÉn th·ªã ngay
        messageDiv.innerHTML = `
            <div class="avatar ${type}">${avatar}</div>
            <div class="message-content">
                ${content}
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        
        // Cu·ªôn m∆∞·ª£t trong container chat, KH√îNG ·∫£nh h∆∞·ªüng ƒë·∫øn trang
        requestAnimationFrame(() => {
            const targetScrollTop = messagesContainer.scrollHeight - messagesContainer.clientHeight;
            messagesContainer.scrollTop = Math.max(0, targetScrollTop);
        });
    }
}

function typeWriterEffect(element, text, messageId = null) {
    let i = 0;
    const speed = 5; // T·ªëc ƒë·ªô g√µ (ms)
    
    // Th√™m class typewriter
    element.classList.add('typewriter-text');
    
    // Ki·ªÉm tra n·∫øu text ch·ª©a HTML
    const hasHTML = /<[^>]*>/.test(text);
    
    if (hasHTML) {
        // X·ª≠ l√Ω HTML v·ªõi typewriter effect
        typeWriterWithHTML(element, text, speed, messageId);
    } else {
        // X·ª≠ l√Ω text thu·∫ßn nh∆∞ c≈©
        typeWriterPlainText(element, text, speed, messageId);
    }
}

function typeWriterPlainText(element, text, speed, messageId) {
    let i = 0;
    
    function typeChar() {
        if (i < text.length) {
            element.innerHTML += text.charAt(i);
            i++;
            
            scrollIfNeeded();
            setTimeout(typeChar, speed);
        } else {
            finishTyping(element, messageId);
        }
    }
    
    typeChar();
}

function typeWriterWithHTML(element, htmlText, speed, messageId) {
    // T·∫°o DOM t·∫°m th·ªùi ƒë·ªÉ parse HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlText;
    
    // L·∫•y to√†n b·ªô text content (kh√¥ng c√≥ tags) ƒë·ªÉ hi·ªÉn th·ªã t·ª´ng k√Ω t·ª±
    const plainText = tempDiv.textContent || tempDiv.innerText || '';
    
    let i = 0;
    let currentHTML = '';
    
    function typeChar() {
        if (i < plainText.length) {
            // Th√™m k√Ω t·ª± hi·ªán t·∫°i
            i++;
            const partialText = plainText.substring(0, i);
            
            // T·∫°o HTML v·ªõi text ƒë√£ g√µ cho ƒë·∫øn hi·ªán t·∫°i
            currentHTML = createPartialHTML(htmlText, partialText);
            element.innerHTML = currentHTML;
            
            scrollIfNeeded();
            setTimeout(typeChar, speed);
        } else {
            // Hi·ªÉn th·ªã HTML ho√†n ch·ªânh khi k·∫øt th√∫c
            element.innerHTML = htmlText;
            finishTyping(element, messageId);
        }
    }
    
    typeChar();
}

function createPartialHTML(fullHTML, partialText) {
    // T·∫°o DOM t·∫°m ƒë·ªÉ x·ª≠ l√Ω HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = fullHTML;
    
    let textIndex = 0;
    let result = '';
    
    // ƒê·ªá quy qua c√°c node ƒë·ªÉ t·∫°o HTML m·ªôt ph·∫ßn
    function processNode(node) {
        if (node.nodeType === Node.TEXT_NODE) {
            const textContent = node.textContent;
            const remainingChars = partialText.length - textIndex;
            
            if (remainingChars <= 0) {
                return '';
            }
            
            const charsToTake = Math.min(textContent.length, remainingChars);
            const partialNodeText = textContent.substring(0, charsToTake);
            textIndex += charsToTake;
            
            return partialNodeText;
        } else if (node.nodeType === Node.ELEMENT_NODE) {
            const tagName = node.tagName.toLowerCase();
            const attributes = Array.from(node.attributes)
                .map(attr => `${attr.name}="${attr.value}"`)
                .join(' ');
            
            let childContent = '';
            for (let child of node.childNodes) {
                childContent += processNode(child);
                if (textIndex >= partialText.length) break;
            }
            
            if (childContent || textIndex < partialText.length) {
                return `<${tagName}${attributes ? ' ' + attributes : ''}>${childContent}</${tagName}>`;
            }
            
            return '';
        }
        
        return '';
    }
    
    for (let child of tempDiv.childNodes) {
        result += processNode(child);
        if (textIndex >= partialText.length) break;
    }
    
    return result;
}

function scrollIfNeeded() {
    // Ch·ªâ cu·ªôn khi th·ª±c s·ª± c·∫ßn thi·∫øt v√† user ƒëang ·ªü cu·ªëi conversation
    const messagesContainer = document.getElementById('chatMessages');
    const isAtBottom = messagesContainer.scrollTop + messagesContainer.clientHeight >= messagesContainer.scrollHeight - 50;
    
    // Ch·ªâ cu·ªôn khi user ƒëang ·ªü g·∫ßn cu·ªëi v√† c·∫ßn thi·∫øt
    if (isAtBottom) {
        // S·ª≠ d·ª•ng scrollTo thay v√¨ scrollTop += ƒë·ªÉ tr√°nh t√≠ch l≈©y l·ªói
        const newScrollTop = messagesContainer.scrollHeight - messagesContainer.clientHeight;
        if (newScrollTop > messagesContainer.scrollTop) {
            messagesContainer.scrollTop = newScrollTop;
        }
    }
}

function finishTyping(element, messageId) {
    // Khi ho√†n th√†nh typing
    element.classList.remove('typewriter-text');
    
    // Hi·ªÉn th·ªã feedback buttons n·∫øu c√≥
    if (messageId) {
        const feedbackButtons = element.parentElement.querySelector('.feedback-buttons');
        if (feedbackButtons) {
            setTimeout(() => {
                feedbackButtons.style.display = 'flex';
            }, 300);
        }
    }
}
}

function smoothScrollTo(element, targetScrollTop, duration) {
    const start = element.scrollTop;
    const change = targetScrollTop - start;
    const startTime = performance.now();
    
    function animateScroll(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function (ease-out)
        const easeOut = 1 - Math.pow(1 - progress, 3);
        
        element.scrollTop = start + (change * easeOut);
        
        if (progress < 1) {
            requestAnimationFrame(animateScroll);
        }
    }
    
    requestAnimationFrame(animateScroll);
}

function addRecommendations(type, items) {
    // Delay ƒë·ªÉ recommendations xu·∫•t hi·ªán sau khi bot message ho√†n th√†nh
    setTimeout(() => {
        const messagesContainer = document.getElementById('chatMessages');
        const recommendationsDiv = document.createElement('div');
        recommendationsDiv.className = 'recommendations';
        recommendationsDiv.style.opacity = '0';
        recommendationsDiv.style.transform = 'translateY(20px)';
        recommendationsDiv.style.transition = 'all 0.8s ease';
    
    let title = '';
    switch(type) {
        case 'products':
            title = 'üõãÔ∏è S·∫£n ph·∫©m g·ª£i √Ω:';
            break;
        case 'projects':
            title = 'üè† D·ª± √°n tham kh·∫£o:';
            break;
        case 'news':
            title = 'üì∞ Tin t·ª©c li√™n quan:';
            break;
    }
    
    let html = `<div style="font-weight: bold; margin-bottom: 10px; color: #333;">${title}</div>`;
    
    items.forEach(item => {
        let url = '';
        let meta = '';
        let description = '';
        
        if (type === 'products') {
            url = `/products/${item.slug}/`;
            meta = `${item.category} ‚Ä¢ ${parseInt(item.price).toLocaleString('vi-VN')} VNƒê`;
            description = item.description ? item.description.substring(0, 150) + '...' : '';
        } else if (type === 'projects') {
            url = `/projects/${item.slug}/`;
            meta = `${item.type} ‚Ä¢ ${item.location}`;
            if (item.gallery_count > 0) {
                meta += ` ‚Ä¢ ${item.gallery_count} ·∫£nh`;
            }
            description = item.description ? item.description.substring(0, 150) + '...' : '';
        } else if (type === 'news') {
            url = `/news/${item.slug}/`;
            meta = `${item.category}`;
            if (item.published_at) {
                meta += ` ‚Ä¢ ${item.published_at}`;
            }
            description = item.summary ? item.summary.substring(0, 150) + '...' : '';
        }
        
        html += `
            <div class="recommendation-item" onclick="window.open('${url}', '_blank')">
                ${item.image ? `
                    <img src="${item.image}" alt="${item.title || item.name}" class="recommendation-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div class="recommendation-image-placeholder" style="display:none;">
                        ${type === 'products' ? 'üõãÔ∏è' : type === 'projects' ? 'üè†' : 'üì∞'}
                    </div>
                ` : `<div class="recommendation-image-placeholder">
                    ${type === 'products' ? 'üõãÔ∏è' : type === 'projects' ? 'üè†' : 'ÔøΩ'}
                </div>`}
                <div class="recommendation-content">
                    <div class="recommendation-title">${item.title || item.name}</div>
                    <div class="recommendation-meta">${meta}</div>
                    ${description ? `<div class="recommendation-description">${description}</div>` : ''}
                </div>
            </div>
        `;
    });
    
    recommendationsDiv.innerHTML = html;
    messagesContainer.appendChild(recommendationsDiv);
    
        // Cu·ªôn m∆∞·ª£t ƒë·ªÉ hi·ªÉn th·ªã recommendations CH·∫¨M v√† t·ª± nhi√™n
        setTimeout(() => {
            // L·∫•y v·ªã tr√≠ hi·ªán t·∫°i
            const currentScrollTop = messagesContainer.scrollTop;
            const targetScrollTop = recommendationsDiv.offsetTop - 50; // Hi·ªÉn th·ªã v·ªõi m·ªôt √≠t margin t·ª´ tr√™n
            
            // Ch·ªâ cu·ªôn n·∫øu recommendations kh√¥ng hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß
            if (targetScrollTop > currentScrollTop) {
                // Cu·ªôn t·ª´ t·ª´ ƒë·∫øn v·ªã tr√≠ recommendations
                smoothScrollTo(messagesContainer, targetScrollTop, 800); // 800ms ƒë·ªÉ cu·ªôn m∆∞·ª£t
            }
            
            // Fade in effect sau khi ƒë√£ cu·ªôn
            setTimeout(() => {
                recommendationsDiv.style.opacity = '1';
                recommendationsDiv.style.transform = 'translateY(0)';
            }, 200);
            
        }, 300);
        
    }, 800); // Delay 800ms sau khi bot message ho√†n th√†nh
}

function showTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    typingIndicator.style.display = 'flex';
    
    // Cu·ªôn m∆∞·ª£t ƒë·∫øn typing indicator
    setTimeout(() => {
        typingIndicator.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'end'
        });
    }, 100);
}

function hideTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'none';
}

function sendFeedback(messageId, rating) {
    fetch('{% url "chatbot:feedback_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: sessionId,
            message_id: messageId,
            rating: rating
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Feedback sent successfully');
        }
    })
    .catch(error => {
        console.error('Error sending feedback:', error);
    });
}

// Auto focus input when page loads
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('chatInput').focus();
    
    // NgƒÉn ch·∫∑n scroll propagation t·ª´ chat container l√™n page
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.addEventListener('wheel', function(e) {
            // NgƒÉn ch·∫∑n scroll event lan truy·ªÅn l√™n document khi ƒë√£ cu·ªôn ƒë·∫øn ƒë·∫ßu/cu·ªëi
            const scrollTop = this.scrollTop;
            const scrollHeight = this.scrollHeight;
            const height = this.clientHeight;
            
            if ((scrollTop === 0 && e.deltaY < 0) || 
                (scrollTop + height >= scrollHeight && e.deltaY > 0)) {
                e.preventDefault();
            }
        }, { passive: false });
    }
});
</script>
{% endblock %}
